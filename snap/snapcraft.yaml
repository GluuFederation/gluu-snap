name: gluu-server
version: 1
summary: Central authentication and authorization for web and mobile applications.
description: |
  Identity & access management (IAM) platform for web & mobile single sign-on (SSO), 
  two-factor authentication (2FA) and API access management.

confinement: strict
base: core18

passthrough:

  layout:
    /opt/jre:
      symlink: $SNAP/gluu-opt/jre
    /opt/jetty:
      symlink: $SNAP/gluu-opt/jetty
    /opt/opendj:
      symlink: $SNAP/gluu-opt/opendj
    /etc/gluu:
       bind: $SNAP_COMMON/etc/gluu
    /opt/install:
      symlink: $SNAP_COMMON/install
    #/var/run/jetty:
    #    type: tmpfs
    /etc/certs:
       symlink: $SNAP_COMMON/etc/certs
    /etc/default/oxauth:
       symlink: $SNAP_COMMON/etc/default/oxauth
    /opt/gluu/jetty/oxauth:
      symlink: $SNAP_COMMON/gluu/jetty/oxauth
    /opt/dist:
      symlink: $SNAP/gluu-opt/dist


parts:

  base-system:
   plugin: nil
   stage-packages:
     - bash
     - python3
     - python3-ldap
     - python3-ldap3
     - python3-requests
     - apache2

  setup-starter:
    plugin: dump
    source: setup/starter
    organize:
      "*" : bin/

  packages:
    plugin: nil
    override-prime: |
      cp $SNAPCRAFT_PRIME/../apps/oxauth-server.war $SNAPCRAFT_PRIME/gluu-opt/dist/gluu/oxauth-server.war
      cp $SNAPCRAFT_PRIME/../apps/community-edition-setup.zip $SNAPCRAFT_PRIME/gluu-opt/dist/gluu/community-edition-setup.zip

  amazon-corretto-jdk:
    plugin: dump
    source: apps/amazon-corretto.tar.gz
    organize:
      "*" : gluu-opt/jre/
    stage-packages:
      # the following packages are needed for amazon-corretto-jdk
      - libgl1
      - libx11-6
      - libxdmcp6
      - libasound2
      - libatk1.0-0
      - libfontconfig1
      - libxcb1
      - libpng16-16
      - libxi6
      - libxrender1
      - libxtst6
      - libcairo2
      - libgdk-pixbuf2.0-0
      - libgraphite2-3
      - libharfbuzz0b
      - libpango-1.0-0 
      - libpangocairo-1.0-0
      - libpangoft2-1.0-0
      - libpixman-1-0
      - libthai0
      - libxcb-render0
      - libxcb-shm0

    override-prime: |
      snapcraftctl prime
      cd $SNAPCRAFT_PRIME/gluu-opt/jre/jre/lib/security; mv cacerts cacerts.bak; ln -s /var/snap/gluu-server/common/etc/certs/java-cacerts

  jetty:
    plugin: dump
    source: apps/jetty.tar.gz
    organize:
      "*" : gluu-opt/jetty/
    override-prime: |
      snapcraftctl prime


  jython:
    plugin: nil
    after: [amazon-corretto-jdk]
    override-prime: |
      snapcraftctl prime
      if [ ! -d "$SNAPCRAFT_PRIME/gluu-opt/jython" ]; then
        $SNAPCRAFT_PRIME/gluu-opt/jre/bin/java -jar $SNAPCRAFT_PRIME/../apps/jython-installer.jar -v -s -d $SNAPCRAFT_PRIME/gluu-opt/jython -t standard -e ensurepip
      fi

  opendj:
    plugin: dump
    source: apps/opendj-server.zip
    source-type: zip
    organize:
      '*' : gluu-opt/
    stage-packages:
       - libpam-cap
       - libcap2-bin
    override-prime: |
      snapcraftctl prime
      echo "/var/snap/gluu-server/common/opendj" > $SNAPCRAFT_PRIME/gluu-opt/opendj/instance.loc


  oxauth:
    plugin: nil
    override-prime: |
      snapcraftctl prime
      mkdir -p $SNAPCRAFT_PRIME/gluu-opt/dist/gluu
      mkdir -p $SNAPCRAFT_PRIME/gluu-opt/dist/scripts
      cp $SNAPCRAFT_PRIME/gluu-opt/jetty/bin/jetty.sh $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/oxauth
      cp $SNAPCRAFT_PRIME/../apps/oxauth-server.war $SNAPCRAFT_PRIME/gluu-opt/dist/gluu/oxauth-server.war
    stage-packages:
      - dpkg
      - coreutils
      - login




apps:

  bash:
    plugs:
     - network
     - network-bind
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA_BIN: "/opt/jre/bin/java"
      OPENDJ_JAVA_HOME: "/opt/jre"
    command: bin/bash

  python:
    plugs:
     - network
     - network-bind
    command: usr/bin/python3

  setup:
    plugs:
     - network
     - network-bind
    command: usr/bin/python3 $SNAP/bin/setup.py

  jython:
    environment:
      JAVA_HOME: "/opt/jre"
    command: gluu-opt/jre/bin/java  -jar $SNAP/gluu-opt/jython/jython.jar


  opendj-setup:
    plugs:
     - network
     - network-bind
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA_BIN: "/opt/jre/bin/java"
      OPENDJ_JAVA_HOME: "/opt/jre"
    command: gluu-opt/opendj/setup


  opendj:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA_BIN: "/opt/jre/bin/java"
      OPENDJ_JAVA_HOME: "/opt/jre"
    plugs:
     - network
     - network-bind
    daemon: forking
    command: gluu-opt/opendj/bin/start-ds
    stop-command: gluu-opt/opendj/bin/stop-ds


  oxauth:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA: "/opt/jre/bin/java"
      JETTY_HOME: "/opt/jetty"

    plugs:
     - network
     - network-bind

    daemon: forking
    command: gluu-opt/dist/scripts/oxauth start
    stop-command: gluu-opt/dist/scripts/oxauth stop

