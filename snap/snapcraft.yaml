name: gluu-server
version: "4.2.0"
summary: Central authentication and authorization for web and mobile applications.
description: |
  Identity & access management (IAM) platform for web & mobile single sign-on (SSO),
  two-factor authentication (2FA) and API access management.

grade: stable
confinement: strict
base: core20

layout:
    /opt/jre:
        symlink: $SNAP/gluu-opt/jre
    /opt/jetty:
        symlink: $SNAP/gluu-opt/jetty
    /opt/opendj:
        symlink: $SNAP/gluu-opt/opendj
    /opt/node:
        symlink: $SNAP/gluu-opt/node
    /opt/oxd-server:
        symlink: $SNAP_COMMON/gluu/oxd-server
    /etc/gluu:
        bind: $SNAP_COMMON/etc/gluu
    /opt/install:
        symlink: $SNAP_COMMON/install
    /var/gluu:
        symlink: $SNAP_COMMON/var/gluu
    /etc/certs:
        symlink: $SNAP_COMMON/etc/certs
    /etc/default:
        bind: $SNAP_COMMON/etc/default
    /opt/gluu:
        symlink: $SNAP_COMMON/gluu
    /opt/dist:
        symlink: $SNAP/gluu-opt/dist
    /usr/lib/apache2:
        symlink: $SNAP/usr/lib/apache2
    /usr/share/apache2:
        symlink: $SNAP/usr/share/apache2
    /etc/apache2:
        symlink: $SNAP_COMMON/etc/apache2
    /var/www/html:
        symlink: $SNAP_COMMON/var/www/html
    /etc/ssl/openssl.cnf:
        bind-file: $SNAP/etc/ssl/openssl.cnf
    /opt/shibboleth-idp:
        symlink: $SNAP_COMMON/gluu/shibboleth-idp
    /usr/bin/facter:
        symlink: $SNAP/usr/bin/facter

parts:
  base-system:
    plugin: nil
    stage-packages:
      - base-files
      - bash
      - sed
      - openssl
      - mime-support
      #followings are for opendj
      - libpam-cap
      - libcap2-bin
      #followings are for oxauth
      - dpkg
      - coreutils
      - login
      # basic utilities
      - unzip
    override-prime: |
      snapcraftctl prime
      sed 's/^RANDFILE/#&/' -i $SNAPCRAFT_PRIME/etc/ssl/openssl.cnf

  python:
    after: [base-system]
    plugin: python
    build-environment:
      - PYTHONPATH: "$SNAPCRAFT_PART_INSTALL/usr/lib/python3/dist-packages"
    stage-packages:
      - python3
      - python3-pip
      - python3-ldap3
      - python3-requests
      - python3-wheel
    python-packages:
      - pydes
      - yacron
      - https://github.com/npcole/npyscreen/archive/master.zip

  facter:
    plugin: dump
    source: apps/facter
    source-type: local
    organize:
      "*" : /usr/bin/

  opendj:
    after: [jython]
    plugin: dump
    source: apps/opendj/opendj-server.zip
    source-type: zip
    organize:
      '*' : gluu-opt/
    override-prime: |
      snapcraftctl prime
      echo "/var/snap/$SNAPCRAFT_PROJECT_NAME/common/opendj" > $SNAPCRAFT_PRIME/gluu-opt/opendj/instance.loc

  apache2:
    after: [base-system]
    plugin: nil
    stage-packages:
      - apache2
    override-prime: |
      snapcraftctl prime
      mv $SNAPCRAFT_PRIME/etc/apache2 $SNAPCRAFT_PRIME/etc/apache2.org

  community-edition-setup:
    plugin: dump
    source: apps/setup/
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/

  amazon-corretto-jdk:
    after: [base-system]
    plugin: dump
    source: apps/corretto/amazon-corretto.tar.gz
    source-type: tar
    organize:
      "*" : gluu-opt/jre/
    stage-packages:
      # the following packages are needed for amazon-corretto-jdk
      - musl
      - libgl1
      - libx11-6
      - libxdmcp6
      - libasound2
      - libatk1.0-0
      - libfontconfig1
      - libxcb1
      - libpng16-16
      - libxi6
      - libxrender1
      - libxtst6
      - libcairo2
      - libgdk-pixbuf2.0-0
      - libgraphite2-3
      - libharfbuzz0b
      - libpango-1.0-0
      - libpangocairo-1.0-0
      - libpangoft2-1.0-0
      - libpixman-1-0
      - libthai0
      - libxcb-render0
      - libxcb-shm0
    override-prime: |
      snapcraftctl prime
      if [ ! -d "$SNAPCRAFT_PRIME/gluu-opt/jre/jre" ]; then
        mkdir $SNAPCRAFT_PRIME/gluu-opt/jre/jre
        cd $SNAPCRAFT_PRIME/gluu-opt/jre/jre; ln -s ../lib
      fi
      if [ ! -f "$SNAPCRAFT_PRIME/gluu-opt/jre/jre/lib/security/cacerts.bak" ]; then
        mv $SNAPCRAFT_PRIME/gluu-opt/jre/jre/lib/security/cacerts $SNAPCRAFT_PRIME/gluu-opt/jre/jre/lib/security/cacerts.bak
        cd $SNAPCRAFT_PRIME/gluu-opt/jre/jre/lib/security/; ln -s /etc/certs/java-cacerts cacerts
      fi

  jetty:
    plugin: dump
    source: apps/jetty/jetty.tar.gz
    source-type: tar
    organize:
      "*" : gluu-opt/jetty/
    override-prime: |
      snapcraftctl prime
      mkdir -p $SNAPCRAFT_PRIME/usr/lib/tmpfiles.d
      cp $SNAPCRAFT_PROJECT_DIR/apps/jetty.conf $SNAPCRAFT_PRIME/usr/lib/tmpfiles.d

  jython:
    plugin: dump
    after: [amazon-corretto-jdk]
    source: apps/jython/
    organize:
      "*" : /gluu-opt/dist/gluu/
    source-type: local
    override-prime: |
      snapcraftctl prime
      if [ ! -d "$SNAPCRAFT_PRIME/gluu-opt/jython" ]; then
        $SNAPCRAFT_PRIME/gluu-opt/jre/bin/java -jar $SNAPCRAFT_PRIME/gluu-opt/dist/gluu/jython-installer.jar -v -s -d $SNAPCRAFT_PRIME/gluu-opt/jython -t standard -e ensurepip
        rm $SNAPCRAFT_PRIME/gluu-opt/dist/gluu/jython-installer.jar
      fi

  node:
    plugin: dump
    source: apps/node/node.tar.xz
    source-type: tar
    organize:
      "*" : gluu-opt/node/

  oxauth:
    after: [jetty]
    plugin: dump
    source: apps/oxauth
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      mkdir -p $SNAPCRAFT_PRIME/gluu-opt/dist/scripts
      cp $SNAPCRAFT_PRIME/gluu-opt/jetty/bin/jetty.sh $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/oxauth

  identity:
    plugin: dump
    after: [oxauth]
    source: apps/identity
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      cp $SNAPCRAFT_PRIME/gluu-opt/jetty/bin/jetty.sh $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/identity

  oxauth-rp:
    plugin: dump
    after: [identity]
    source: apps/oxauth-rp
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      cp $SNAPCRAFT_PRIME/gluu-opt/jetty/bin/jetty.sh $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/oxauth-rp

  idp:
    plugin: dump
    after: [identity]
    source: apps/idp
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      cp $SNAPCRAFT_PRIME/gluu-opt/jetty/bin/jetty.sh $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/idp

  casa:
    plugin: dump
    after: [identity]
    source: apps/casa
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      cp $SNAPCRAFT_PRIME/gluu-opt/jetty/bin/jetty.sh $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/casa

  scim:
    plugin: dump
    after: [identity]
    source: apps/scim
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      cp $SNAPCRAFT_PRIME/gluu-opt/jetty/bin/jetty.sh $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/scim

  fido2:
    plugin: dump
    after: [identity]
    source: apps/fido2
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      cp $SNAPCRAFT_PRIME/gluu-opt/jetty/bin/jetty.sh $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/fido2

  oxd-server:
    plugin: dump
    source: apps/oxd-server
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      mv $SNAPCRAFT_PRIME/gluu-opt/dist/gluu/oxd-server $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/oxd-server
      chmod +x $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/oxd-server

  passport:
    plugin: dump
    source: apps/passport
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      mv $SNAPCRAFT_PRIME/gluu-opt/dist/gluu/passport $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/passport
      chmod +x $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/passport

  gluu-radius:
    plugin: dump
    source: apps/radius
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      if [ ! -d "$SNAPCRAFT_PRIME/gluu-opt/dist/scripts" ]; then
        mkdir -p $SNAPCRAFT_PRIME/gluu-opt/dist/scripts
      fi
      mv $SNAPCRAFT_PRIME/gluu-opt/dist/gluu/gluu-radius $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/gluu-radius
      chmod +x $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/gluu-radius

apps:
  bash:
    plugs:
     - network
     - network-bind
     - network-observe
     - mount-observe
     - system-observe
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA_BIN: "/opt/jre/bin/java"
      OPENDJ_JAVA_HOME: "/opt/jre"
      PYTHONWARNINGS: "ignore"
      PYTHONPATH: "$SNAP/usr/lib/python3/dist-packages"
    command: bin/bash

  yacron:
    command: bin/yacron -c $SNAP_COMMON/etc/cron-jobs.yaml
    daemon: simple

  python:
    environment:
      PYTHONPATH: "$SNAP/usr/lib/python3/dist-packages"
    plugs:
     - network
     - network-bind
    command: bin/python3

  setup:
    environment:
      PYTHONPATH: "$SNAP/usr/lib/python3/dist-packages"
      PYTHONUTF8: "1"
    plugs:
     - network
     - network-bind
    command: bin/python3 $SNAP_COMMON/install/community-edition-setup/setup.py

  version:
    environment:
      PYTHONPATH: "$SNAP/usr/lib/python3/dist-packages"
    plugs:
     - network
    command: bin/python3 $SNAP_COMMON/install/community-edition-setup/setup_app/utils/printVersion.py

  apache2:
    environment:
      APACHE_RUN_USER:  "daemon"
      APACHE_RUN_GROUP: "daemon"
      APACHE_PID_FILE:  "/opt/gluu/run/apache2/apache2.pid"
      APACHE_RUN_DIR:   "/opt/gluu/run/apache2"
      APACHE_LOCK_DIR:  "/opt/gluu/run/apache2"
      APACHE_LOG_DIR:   "/opt/gluu/log/apache2"
    command: usr/sbin/apache2 -d $SNAP_COMMON/etc/apache2 -k start
    stop-command: usr/sbin/apache2 -d $SNAP_COMMON/etc/apache2 -k stop
    daemon: forking
    restart-condition: always
    plugs:
      - network
      - network-bind

  jython:
    environment:
      JAVA_HOME: "/opt/jre"
    command: gluu-opt/jre/bin/java  -jar $SNAP/gluu-opt/jython/jython.jar

  opendj:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA_BIN: "/opt/jre/bin/java"
      OPENDJ_JAVA_HOME: "/opt/jre"
    plugs:
     - network
     - network-bind
    daemon: forking
    restart-condition: never
    command: gluu-opt/opendj/bin/start-ds
    stop-command: gluu-opt/opendj/bin/stop-ds

  oxauth:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA: "/opt/jre/bin/java"
      JETTY_RUN: "/opt/gluu/jetty/oxauth/run"
    plugs:
     - network
     - network-bind
    daemon: forking
    restart-condition: never
    command: gluu-opt/dist/scripts/oxauth start
    stop-command: gluu-opt/dist/scripts/oxauth stop

  identity:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA: "/opt/jre/bin/java"
      JETTY_RUN: "/opt/gluu/jetty/identity/run"
      PYTHONWARNINGS: "ignore"
    plugs:
     - network
     - network-bind
     - network-observe
     - mount-observe
     - system-observe
    daemon: forking
    restart-condition: never
    command: gluu-opt/dist/scripts/identity start
    stop-command: gluu-opt/dist/scripts/identity stop

  idp:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA: "/opt/jre/bin/java"
      JETTY_RUN: "/opt/gluu/jetty/idp/run"
    plugs:
     - network
     - network-bind
    daemon: forking
    restart-condition: never
    command: gluu-opt/dist/scripts/idp start
    stop-command: gluu-opt/dist/scripts/idp stop

  oxauth-rp:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA: "/opt/jre/bin/java"
      JETTY_RUN: "/opt/gluu/jetty/oxauth-rp/run"
    plugs:
     - network
     - network-bind
    daemon: forking
    restart-condition: never
    command: gluu-opt/dist/scripts/oxauth-rp start
    stop-command: gluu-opt/dist/scripts/oxauth-rp stop

  casa:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA: "/opt/jre/bin/java"
      JETTY_RUN: "/opt/gluu/jetty/casa/run"
    plugs:
     - network
     - network-bind
    daemon: forking
    restart-condition: never
    command: gluu-opt/dist/scripts/casa start
    stop-command: gluu-opt/dist/scripts/casa stop

  scim:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA: "/opt/jre/bin/java"
      JETTY_RUN: "/opt/gluu/jetty/scim/run"
    plugs:
     - network
     - network-bind
    daemon: forking
    restart-condition: never
    command: gluu-opt/dist/scripts/scim start
    stop-command: gluu-opt/dist/scripts/scim stop

  fido2:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA: "/opt/jre/bin/java"
      JETTY_RUN: "/opt/gluu/jetty/fido2/run"
    plugs:
     - network
     - network-bind
    daemon: forking
    restart-condition: never
    command: gluu-opt/dist/scripts/fido2 start
    stop-command: gluu-opt/dist/scripts/fido2 stop

  passport:
    environment:
      NODE_USER: "root"
      NODE_PID_FILE: "/opt/gluu/node/passport.pid"
    plugs:
     - network
     - network-bind
    daemon: forking
    restart-condition: never
    command: gluu-opt/dist/scripts/passport start
    stop-command: gluu-opt/dist/scripts/passport stop

  gluu-radius:
    environment:
      RADIUS_RUN: "/opt/gluu/radius/run"
      GLUU_RADIUS_USER: "root"
      GLUU_RADIUS_GROUP: "root"
    plugs:
     - network
     - network-bind
    daemon: forking
    restart-condition: never
    command: gluu-opt/dist/scripts/gluu-radius start
    stop-command: gluu-opt/dist/scripts/gluu-radius stop

  oxd-server:
    environment:
      OXD_USER: "root"
      OXD_LOGS: "/opt/oxd-server/log"
    plugs:
     - network
     - network-bind
    daemon: forking
    restart-condition: never
    command: gluu-opt/dist/scripts/oxd-server start
    stop-command: gluu-opt/dist/scripts/oxd-server stop
