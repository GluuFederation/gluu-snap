name: gluu-server
version: 4.1
summary: Central authentication and authorization for web and mobile applications.
description: |
  Identity & access management (IAM) platform for web & mobile single sign-on (SSO), 
  two-factor authentication (2FA) and API access management.

confinement: strict
base: core18

passthrough:

  system-usernames:
    snap_daemon: shared

  layout:
    /opt/jre:
      symlink: $SNAP/gluu-opt/jre
    /opt/jetty:
      symlink: $SNAP/gluu-opt/jetty
    /opt/opendj:
      symlink: $SNAP/gluu-opt/opendj
    /etc/gluu:
       bind: $SNAP_COMMON/etc/gluu
    /opt/install:
      symlink: $SNAP_COMMON/install
    /var/gluu:
        symlink: $SNAP_COMMON/var/gluu
    /etc/certs:
       symlink: $SNAP_COMMON/etc/certs
    /etc/default/oxauth:
       symlink: $SNAP_COMMON/etc/default/oxauth
    /etc/default/identity:
       symlink: $SNAP_COMMON/etc/default/identity
    /etc/default/idp:
       symlink: $SNAP_COMMON/etc/default/idp
    /opt/gluu:
      symlink: $SNAP_COMMON/gluu
    /opt/dist:
      symlink: $SNAP/gluu-opt/dist
    /usr/lib/apache2:
      symlink: $SNAP/usr/lib/apache2
    /usr/share/apache2:
      symlink: $SNAP/usr/share/apache2
    /var/www/html:
      symlink: $SNAP_COMMON/var/www/html
    /etc/ssl/openssl.cnf:
      bind-file: $SNAP/etc/ssl/openssl.cnf
    /opt/shibboleth-idp:
      symlink: $SNAP_COMMON/gluu/shibboleth-idp


parts:

  base-system:
    plugin: nil
    stage-packages:
      - bash
      - python3
      - python3-ldap
      - python3-ldap3
      - python3-requests
      - openssl
      - python3-pip
      #followings are for opendj
      - libpam-cap
      - libcap2-bin
      #followings are for oxauth
      - dpkg
      - coreutils
      - login
      
    override-prime: |
      snapcraftctl prime
      sed 's/^RANDFILE/#&/' -i $SNAPCRAFT_PRIME/etc/ssl/openssl.cnf

  yacron:
   after: [base-system]
   plugin: python
   python-packages:
     - yacron
     - pyyaml
   

  apache2:
    after: [base-system]
    plugin: nil
    stage-packages:
      - apache2

  setup-starter:
    plugin: dump
    source: setup/starter
    source-type: local
    organize:
      "*" : bin/

  community-edition-setup:
    plugin: dump
    source: apps/setup/
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/

  amazon-corretto-jdk:
    after: [base-system]
    plugin: dump
    source: apps/corretto/amazon-corretto.tar.gz
    organize:
      "*" : gluu-opt/jre/
    stage-packages:
      # the following packages are needed for amazon-corretto-jdk
      - libgl1
      - libx11-6
      - libxdmcp6
      - libasound2
      - libatk1.0-0
      - libfontconfig1
      - libxcb1
      - libpng16-16
      - libxi6
      - libxrender1
      - libxtst6
      - libcairo2
      - libgdk-pixbuf2.0-0
      - libgraphite2-3
      - libharfbuzz0b
      - libpango-1.0-0 
      - libpangocairo-1.0-0
      - libpangoft2-1.0-0
      - libpixman-1-0
      - libthai0
      - libxcb-render0
      - libxcb-shm0

    override-prime: |
      snapcraftctl prime
      if [ -f "$SNAPCRAFT_PRIME/gluu-opt/jre/jre/lib/security/cacerts" ]; then
        mv $SNAPCRAFT_PRIME/gluu-opt/jre/jre/lib/security/cacerts $SNAPCRAFT_PRIME/gluu-opt/jre/jre/lib/security/cacerts.bak
        ln -s /var/snap/gluu-server/common/etc/certs/java-cacerts $SNAPCRAFT_PRIME/gluu-opt/jre/jre/lib/security/cacerts
      fi


  jetty:
    plugin: dump
    source: apps/jetty/jetty.tar.gz
    organize:
      "*" : gluu-opt/jetty/

  jython:
    plugin: dump
    after: [amazon-corretto-jdk]
    source: apps/jython/
    organize:
      "*" : /gluu-opt/dist/gluu/
    source-type: local
    override-prime: |
      snapcraftctl prime
      if [ ! -d "$SNAPCRAFT_PRIME/gluu-opt/jython" ]; then
        $SNAPCRAFT_PRIME/gluu-opt/jre/bin/java -jar $SNAPCRAFT_PRIME/gluu-opt/dist/gluu/jython-installer.jar -v -s -d $SNAPCRAFT_PRIME/gluu-opt/jython -t standard -e ensurepip
        rm $SNAPCRAFT_PRIME/gluu-opt/dist/gluu/jython-installer.jar
      fi

  opendj:
    after: [jython]
    plugin: dump
    source: apps/opendj/opendj-server.zip
    source-type: zip
    organize:
      '*' : gluu-opt/
    override-prime: |
      snapcraftctl prime
      echo "/var/snap/$SNAPCRAFT_PROJECT_NAME/common/opendj" > $SNAPCRAFT_PRIME/gluu-opt/opendj/instance.loc

  oxauth:
    after: [jetty]
    plugin: dump
    source: apps/oxauth
    source-type: local
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      mkdir -p $SNAPCRAFT_PRIME/gluu-opt/dist/scripts
      cp $SNAPCRAFT_PRIME/gluu-opt/jetty/bin/jetty.sh $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/oxauth

  identity:
    plugin: dump
    after: [oxauth]
    source: apps/identity
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      cp $SNAPCRAFT_PRIME/gluu-opt/jetty/bin/jetty.sh $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/identity

  idp:
    plugin: dump
    after: [identity]
    source: apps/idp
    organize:
      "*" : /gluu-opt/dist/gluu/
    override-prime: |
      snapcraftctl prime
      cp $SNAPCRAFT_PRIME/gluu-opt/jetty/bin/jetty.sh $SNAPCRAFT_PRIME/gluu-opt/dist/scripts/idp

apps:

  bash:
    plugs:
     - network
     - network-bind
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA_BIN: "/opt/jre/bin/java"
      OPENDJ_JAVA_HOME: "/opt/jre"
    command: bin/bash

  yacron:
    command: bin/yacron -c $SNAP_COMMON/etc/cron-jobs.yaml
    daemon: simple

  python:
    plugs:
     - network
     - network-bind
    command: usr/bin/python3

  setup:
    plugs:
     - network
     - network-bind
    command: usr/bin/python3 $SNAP/bin/setup.py

  apache:
    environment:
      APACHE_RUN_USER:  "snap_daemon"
      APACHE_RUN_GROUP: "snap_daemon"
      APACHE_PID_FILE:  "/opt/gluu/run/apache2/apache2.pid"
      APACHE_RUN_DIR:   "/opt/gluu/run/apache2"
      APACHE_LOCK_DIR:  "/opt/gluu/run/apache2"
      APACHE_LOG_DIR:   "/opt/gluu/log/apache2"

    command: usr/sbin/apache2 -d $SNAP_COMMON/etc/apache2 -k start
    stop-command: usr/sbin/apache2 -d $SNAP_COMMON/etc/apache2 -k stop
    daemon: forking
    restart-condition: always
    plugs:
      - network
      - network-bind

  jython:
    environment:
      JAVA_HOME: "/opt/jre"
    command: gluu-opt/jre/bin/java  -jar $SNAP/gluu-opt/jython/jython.jar


  opendj-setup:
    plugs:
     - network
     - network-bind
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA_BIN: "/opt/jre/bin/java"
      OPENDJ_JAVA_HOME: "/opt/jre"
    command: gluu-opt/opendj/setup


  opendj:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA_BIN: "/opt/jre/bin/java"
      OPENDJ_JAVA_HOME: "/opt/jre"
    plugs:
     - network
     - network-bind
    daemon: forking
    command: gluu-opt/opendj/bin/start-ds
    stop-command: gluu-opt/opendj/bin/stop-ds


  oxauth:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA: "/opt/jre/bin/java"
      JETTY_HOME: "/opt/jetty"
      JETTY_RUN: "/tmp/jetty_temp"

    plugs:
     - network
     - network-bind

    daemon: forking
    command: gluu-opt/dist/scripts/oxauth start
    stop-command: gluu-opt/dist/scripts/oxauth stop


  identity:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA: "/opt/jre/bin/java"
      JETTY_HOME: "/opt/jetty"
      JETTY_RUN: "/tmp/jetty_temp"

    plugs:
     - network
     - network-bind

    daemon: forking
    command: gluu-opt/dist/scripts/identity start
    stop-command: gluu-opt/dist/scripts/identity stop

  idp:
    environment:
      JAVA_HOME: "/opt/jre"
      JAVA: "/opt/jre/bin/java"
      JETTY_HOME: "/opt/jetty"
      JETTY_RUN: "/tmp/jetty_temp"

    plugs:
     - network
     - network-bind

    daemon: forking
    command: gluu-opt/dist/scripts/idp start
    stop-command: gluu-opt/dist/scripts/idp stop
